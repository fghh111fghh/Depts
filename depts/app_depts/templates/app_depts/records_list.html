{% extends 'app_main/base.html' %}
{% load humanize %}

{% block content %}
<div class="dashboard-wrapper" style="padding: 20px 0;">

    <div class="stats-container">

        <div class="stat-card card-debt">
            <span class="stat-label">Активный долг</span>
            <span class="stat-value">{{ total_unpaid_amount|floatformat:2 |intcomma }} <small>₽</small></span>
        </div>

        <div class="stat-card card-progress">
            <span class="stat-label">Общий прогресс</span>
            <span class="stat-value stat-value-success">{{ overall_progress }}%</span>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" style="width: {{ overall_progress|stringformat:'f' }}%;"></div>
            </div>
        </div>

        <div class="stat-card {% if overdue_count > 0 %}card-overdue{% else %}card-activity{% endif %}">
            <span class="stat-label">Активность</span>

            <div class="stat-content">
                <div class="stat-row">
                    <span class="stat-number">{{ creditors_count }}</span>
                    <span>Кредиторов</span>
                </div>

                <div class="stat-row stat-divider">
                    <span class="stat-number">{{ records_count }}</span>
                    <span>Долгов</span>
                </div>

                {% if overdue_count > 0 %}
                <div class="overdue-alert" title="Обязательства с истекшим сроком">
                    <i class="fa-solid fa-triangle-exclamation"></i> Просрочено: {{ overdue_count }}
                </div>
                {% endif %}
            </div>
        </div>

    </div>

    <div class="export-actions">
        <button onclick="exportData('excel')" class="btn-export">Скачать Excel</button>
        <button onclick="exportData('pdf')" class="btn-export">Скачать PDF</button>
    </div>

    <div class="controls-panel">
        <div class="search-options-row">
            <form action="" method="GET" class="search-form">
                <div class="search-input-wrapper">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    <input type="text" id="search-input" name="q" value="{{ search_query|default:'' }}"
                           placeholder="Поиск..." class="search-input" list="depts-list">
                    <datalist id="depts-list">
                        {% for r in records_all %}
                        <option value="{{ r.name }}">
                        <option value="{{ r.creditor.name }}">
                            {% endfor %}
                    </datalist>
                    <div id="search-results" class="search-suggestions"></div>
                </div>
                {% if current_type %}<input type="hidden" name="creditor_type" value="{{ current_type }}">{% endif %}
                {% if current_sort %}<input type="hidden" name="sort" value="{{ current_sort }}">{% endif %}
                {% if show_paid %}<input type="hidden" name="show_paid" value="1">{% endif %}
                <button type="submit" class="search-button">НАЙТИ</button>
                {% if search_query or current_sort or current_type or show_paid or is_urgent %}
                <a href="{% url 'app_depts:records_list' %}" class="reset-button">
                    <i class="fa-solid fa-rotate-left"></i> СБРОСИТЬ
                </a>
                {% endif %}
            </form>

            <div class="sort-container">
                <span>СОРТИРОВАТЬ:</span>

                <a href="?sort=creditor{% if search_query %}&q={{ search_query }}{% endif %}{% if current_type %}&creditor_type={{ current_type }}{% endif %}{% if show_paid %}&show_paid=1{% endif %}"
                   class="sort-link {% if current_sort == 'creditor' %}active{% endif %}">КРЕДИТОР</a>

                <a href="?sort=amount{% if search_query %}&q={{ search_query }}{% endif %}{% if current_type %}&creditor_type={{ current_type }}{% endif %}{% if show_paid %}&show_paid=1{% endif %}"
                   class="sort-link {% if current_sort == 'amount' %}active{% endif %}">СУММА</a>

                <a href="?sort=end_date{% if search_query %}&q={{ search_query }}{% endif %}{% if current_type %}&creditor_type={{ current_type }}{% endif %}{% if show_paid %}&show_paid=1{% endif %}"
                   class="sort-link {% if current_sort == 'end_date' %}active{% endif %}">СРОК</a>
            </div>
        </div>

        <div class="filter-type-row">
            <div class="filter-type-group">
                <span class="filter-label">Организации:</span>

                <a href="?{% if search_query %}q={{ search_query }}&{% endif %}{% if current_sort %}sort={{ current_sort }}&{% endif %}{% if show_paid %}show_paid=1{% endif %}"
                   class="type-link {% if not current_type and not is_urgent %}active-all{% endif %}">
                    ВСЕ
                </a>

                {% for type_value, type_label in creditor_types %}
                <a href="?creditor_type={{ type_value }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if show_paid %}&show_paid=1{% endif %}"
                   class="type-link {{ type_value|lower }} {% if current_type == type_value %}active{% endif %}">
                    {{ type_label|upper }}
                </a>
                {% endfor %}
                <a href="?urgent={% if is_urgent %}0{% else %}1{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_type %}&creditor_type={{ current_type }}{% endif %}"
                   class="type-link urgent-link {% if is_urgent %}active-urgent{% endif %}">
                    <i class="fa-solid fa-fire-flame-curved"></i> СРОЧНЫЕ
                </a>
            </div>
            <div>
                <a href="?{% if show_paid %}show_paid=0{% else %}show_paid=1{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_type %}&creditor_type={{ current_type }}{% endif %}"
                   class="paid-toggle {% if show_paid %}active{% endif %}">
                    {% if show_paid %}
                    <i class="fa-solid fa-eye"></i> ПОКАЗАНЫ ВСЕ
                    {% else %}
                    <i class="fa-solid fa-eye-slash"></i> ТОЛЬКО АКТИВНЫЕ
                    {% endif %}
                </a>
            </div>
        </div>
    </div>

    <div class="records-grid">
        {% for record in records %}
        <div class="app-module-card {% if record.is_near_deadline %}deadline-warning{% endif %}">
            {% if record.is_near_deadline and not record.is_paid %}
            <div class="deadline-urgent-badge">
                <i class="fa-solid fa-clock-rotate-left"></i> СРОК ИСТЕКАЕТ!
            </div>
            filter-type-row
            {% endif %}
            {% if record.is_paid %}
            <div class="card-status-icon">
                <i class="fa-solid fa-circle-check"></i>
            </div>
            {% endif %}

            <div class="card-body">
                <h3 class="record-card-title">{{ record.name }}</h3>
                <p class="record-card-creditor">{{ record.creditor.name }}</p>

                {% if record.creditor.phone or record.creditor.website %}
                <div class="card-contacts-row">
                    {% if record.creditor.phone %}
                    <a href="tel:{{ record.creditor.phone }}" class="card-link">
                        <i class="fa-solid fa-phone icon-phone"></i>
                        <span>{{ record.creditor.phone }}</span>
                    </a>
                    {% endif %}

                    {% if record.creditor.website %}
                    <a href="{{ record.creditor.website }}" target="_blank" class="card-link">
                        <i class="fa-solid fa-globe icon-globe"></i>
                        <span>Сайт</span>
                    </a>
                    {% endif %}
                </div>
                {% else %}
                <div class="card-contacts-spacer"></div>
                {% endif %}

                {% if record.note %}
                <div class="card-note">
                    <i class="fa-solid fa-note-sticky note-icon"></i> {{ record.note|default:"&nbsp;" }}
                </div>
                {% endif %}

                <div class="card-main-amount">
    <span class="amount-label">
        {% if record.is_paid %}Выплачено{% else %}Остаток{% endif %}
    </span>
                    <span class="amount-sum">
        {% if record.is_paid %}{{ record.total_paid|floatformat:2 }}{% else %}{{ record.balance|floatformat:2 |intcomma }}{% endif %}
        <small>₽</small>
    </span>
                </div>

                <div class="card-status-bar">
                    {% if record.is_paid %}
                    <span class="status-badge paid">ПОГАШЕНО</span>
                    {% elif record.end_date %}
                    <span class="status-badge {% if record.end_date < today %}overdue{% else %}active{% endif %}">
            До {{ record.end_date|date:"d.m.Y" }}
        </span>
                    {% else %}
                    <span class="status-badge empty">Срок не указан</span>
                    {% endif %}
                </div>

                <div class="card-progress-details">
                    <span>ВЫПЛАЧЕНО: <span class="percent-value">{{ record.progress_percent }}%</span></span>
                    <span class="paid-amount">{{ record.total_paid|floatformat:0 |intcomma }} ₽</span>
                </div>
                <div class="card-progress-track">
                    <div class="card-progress-bar {% if record.is_paid %}paid{% endif %}"
                         style="width: {{ record.progress_percent|stringformat:'f' }}%;">
                    </div>
                </div>

                <div class="card-actions">
                    {% if not record.is_paid %}
                    <button onclick="document.getElementById('modal-{{ record.slug }}').style.display='flex'"
                            class="btn-payment-add">
                        + ВНЕСТИ ПЛАТЕЖ
                    </button>
                    {% endif %}
                    <a href="{{ record.get_absolute_url }}" class="btn-details">
                        ДЕТАЛИ И ИСТОРИЯ
                    </a>
                </div>
            </div>
        </div>

        <div id="modal-{{ record.slug }}" class="modal-overlay">
            <div class="modal-content">
                <h2 class="modal-title">Внести платеж</h2>
                <p class="modal-subtitle">
                    {{ record.name }} <br>
                    <span class="modal-balance-info">(Остаток: <strong>{{ record.balance|floatformat:2 |intcomma }} ₽</strong>)</span>
                </p>
                <form action="{% url 'app_depts:quick_payment' record.slug %}" method="POST" class="modal-form">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="number" name="amount" id="amount-list-{{ record.slug }}"
                               step="0.01" required placeholder="Сумма ₽"
                               class="modal-input-amount">
                        <button type="button"
                                class="btn-pay-all"
                                onclick="document.getElementById('amount-list-{{ record.slug }}').value = '{{ record.balance|stringformat:'.2f' }}'.replace(',', '.')">
                            ОПЛАТИТЬ ВСЁ
                        </button>
                    </div>
                    <input type="text" name="comment" placeholder="Комментарий (необязательно)"
                           class="modal-input-comment">
                    <div class="modal-footer-btns">
                        <button type="submit" class="btn-confirm">ОК</button>
                        <button type="button" class="btn-cancel"
                                onclick="document.getElementById('modal-{{ record.slug }}').style.display='none'">
                            ОТМЕНА
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fa-solid fa-magnifying-glass"></i>
            </div>
            <p class="empty-state-text">По вашему запросу ничего не найдено.</p>
            <a href="{% url 'app_depts:records_list' %}" class="btn-reset-filters">
                СБРОСИТЬ ВСЕ ФИЛЬТРЫ
            </a>
        </div>
        {% endfor %}
    </div>

    {% if is_paginated %}
    <div class="pagination-container">

        {# Кнопка НАЗАД (стрелка) #}
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_type %}&creditor_type={{ current_type }}{% endif %}{% if show_paid %}&show_paid=1{% endif %}"
           class="pagination-arrow">
            <i class="fa-solid fa-chevron-left"></i>
        </a>

        {# Номер предыдущей страницы #}
        <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_type %}&creditor_type={{ current_type }}{% endif %}{% if show_paid %}&show_paid=1{% endif %}"
           class="pagination-link">
            {{ page_obj.previous_page_number }}
        </a>
        {% endif %}

        {# АКТИВНАЯ СТРАНИЦА (без ссылки) #}
        <span class="pagination-current">
    {{ page_obj.number }}
</span>

        {# Кнопка ВПЕРЕД (номер и стрелка) #}
        {% if page_obj.has_next %}
        {# Номер следующей страницы #}
        <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_type %}&creditor_type={{ current_type }}{% endif %}{% if show_paid %}&show_paid=1{% endif %}"
           class="pagination-link">
            {{ page_obj.next_page_number }}
        </a>

        <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}{% if current_type %}&creditor_type={{ current_type }}{% endif %}{% if show_paid %}&show_paid=1{% endif %}"
           class="pagination-arrow next">
            <i class="fa-solid fa-chevron-right"></i>
        </a>
        {% endif %}

    </div>

    <div class="pagination-info">
        Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
    </div>
    {% endif %}

</div>
<script>
    function exportData(format) {
            let baseUrl = "";

            if (format === 'excel') {
                baseUrl = "{% url 'app_depts:export_excel' %}";
            } else if (format === 'pdf') {
                baseUrl = "{% url 'app_depts:export_pdf' %}";
            }

            if (baseUrl) {
                // Собираем текущие параметры фильтрации (поиск, категории и т.д.)
                const currentParams = window.location.search;
                window.location.href = baseUrl + currentParams;
            }
        }
</script>
{% endblock %}