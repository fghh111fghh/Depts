{% extends 'base.html' %}
{% load static %}

{% block title %}–£—á—ë—Ç —Å—Ç–∞–≤–æ–∫{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'app_bets/css/bet_records.css' %}">
<style>
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç –≤ CSS —Ñ–∞–π–ª–µ */
    .btn-signals {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        border: none;
        cursor: pointer;
    }

    .btn-signals:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-signals .badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 2px 8px;
        border-radius: 20px;
        font-size: 0.9rem;
        margin-left: 5px;
    }

    /* –£—Å–∏–ª–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –ø—Ä–∏–±—ã–ª–∏ */
    .profit-positive {
        color: #00ff00 !important;
        font-weight: 700 !important;
        text-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
    }

    .profit-negative {
        color: #ff3333 !important;
        font-weight: 700 !important;
        text-shadow: 0 0 5px rgba(255, 51, 51, 0.3);
    }

    /* –ë–ª–æ–∫ –ø—Ä–∏–±—ã–ª–∏ —Å –±–ª–µ–∫–ª—ã–º —Ñ–æ–Ω–æ–º */
    .profit-badge {
        background: rgba(255, 255, 255, 0.15) !important;
        border-radius: 8px;
        padding: 5px 10px;
    }

    .bet-profit {
        font-size: 1.2rem;
        font-weight: 700;
    }

    /* –£–±–∏—Ä–∞–µ–º –∑–Ω–∞–∫ –º–∏–Ω—É—Å, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–≤–µ—Ç */
    .profit-negative::before {
        content: "";
    }
</style>
{% endblock %}

{% block content %}
<div class="bets-container">
    <!-- –ë–∞–ª–∞–Ω—Å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="balance-card">
        <div class="balance-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
        <div class="balance-amount">{{ current_balance|floatformat:0 }} ‚ÇΩ</div>

        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-label">–í—Å–µ–≥–æ —Å—Ç–∞–≤–æ–∫</div>
                <div class="stat-value">{{ total_bets }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">–í—ã–∏–≥—Ä—ã—à–∏</div>
                <div class="stat-value">{{ wins_count }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">–ü—Ä–æ–∏–≥—Ä—ã—à–∏</div>
                <div class="stat-value">{{ losses_count }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">–í–æ–∑–≤—Ä–∞—Ç—ã</div>
                <div class="stat-value">{{ refunds_count }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">–°—É–º–º–∞ —Å—Ç–∞–≤–æ–∫</div>
                <div class="stat-value">{{ total_stake|floatformat:0 }} ‚ÇΩ</div>
            </div>
            <div class="stat-item profit-badge">
                <div class="stat-label">–ü—Ä–∏–±—ã–ª—å</div>
                <div class="stat-value {% if total_profit > 0 %}profit-positive{% elif total_profit < 0 %}profit-negative{% endif %}">
                    {{ total_profit|floatformat:0|cut:"-" }} ‚ÇΩ
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="action-bar">
        <div class="action-group">
            <select id="bulkAction" class="action-select">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</option>
                <option value="mark_win">‚úì –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–∏–≥—Ä—ã—à</option>
                <option value="mark_loss">‚úó –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ–∏–≥—Ä—ã—à</option>
                <option value="mark_refund">‚Ü© –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤–æ–∑–≤—Ä–∞—Ç</option>
                <option value="delete">üóë –£–¥–∞–ª–∏—Ç—å</option>
            </select>
            <button id="applyBulkAction" class="btn btn-primary" disabled>–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>

        <div class="action-group ml-auto" style="display: flex; gap: 10px;">
            <!-- –ö–Ω–æ–ø–∫–∞ –°–∏–≥–Ω–∞–ª—ã (–∫–∞–∫ –≤ cleaned —à–∞–±–ª–æ–Ω–µ) -->
            <a href="{% url 'app_bets:cleaned' %}" class="btn-signals">
                <i class="fa-solid fa-chart-line"></i> –°–∏–≥–Ω–∞–ª—ã
                <span class="badge">–∞–Ω–∞–ª–∏–∑</span>
            </a>

            <!-- –ö–Ω–æ–ø–∫–∞ Excel -->
            <a href="{% url 'app_bets:export_bets_excel' %}?{{ request.GET.urlencode }}" class="btn btn-excel">
                üìä Excel
            </a>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    <div class="filters-panel">
        <div class="filters-title" onclick="toggleFilters()">
            <span>üîç –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</span>
            <span id="filterToggle">‚ñº</span>
        </div>

        <form id="filterForm" method="get">
            <div class="filters-grid">
                <!-- –ü–æ–∏—Å–∫ -->
                <div class="filter-group">
                    <label>–ü–æ–∏—Å–∫</label>
                    <input type="text" name="search" value="{{ request.GET.search }}" placeholder="–ö–æ–º–∞–Ω–¥–∞ –∏–ª–∏ –ª–∏–≥–∞...">
                </div>

                <!-- –î–∞—Ç–∞ -->
                <div class="filter-group">
                    <label>–î–∞—Ç–∞ —Å</label>
                    <input type="date" name="date_from" value="{{ request.GET.date_from }}">
                </div>

                <div class="filter-group">
                    <label>–î–∞—Ç–∞ –ø–æ</label>
                    <input type="date" name="date_to" value="{{ request.GET.date_to }}">
                </div>

                <!-- –°–ø–æ—Ä—Ç -->
                <div class="filter-group">
                    <label>–í–∏–¥ —Å–ø–æ—Ä—Ç–∞</label>
                    <select name="sport">
                        <option value="">–í—Å–µ</option>
                        {% for sport in sports %}
                        <option value="{{ sport.id }}" {% if request.GET.sport == sport.id|stringformat:"s" %}selected{% endif %}>
                            {{ sport.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- –õ–∏–≥–∞ -->
                <div class="filter-group">
                    <label>–õ–∏–≥–∞</label>
                    <select name="league">
                        <option value="">–í—Å–µ</option>
                        {% for league in leagues %}
                        <option value="{{ league.id }}" {% if request.GET.league == league.id|stringformat:"s" %}selected{% endif %}>
                            {{ league.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
                <div class="filter-group">
                    <label>–†–µ–∑—É–ª—å—Ç–∞—Ç</label>
                    <select name="result">
                        <option value="">–í—Å–µ</option>
                        <option value="WIN" {% if request.GET.result == 'WIN' %}selected{% endif %}>–í—ã–∏–≥—Ä—ã—à</option>
                        <option value="LOSS" {% if request.GET.result == 'LOSS' %}selected{% endif %}>–ü—Ä–æ–∏–≥—Ä—ã—à</option>
                        <option value="REFUND" {% if request.GET.result == 'REFUND' %}selected{% endif %}>–í–æ–∑–≤—Ä–∞—Ç</option>
                    </select>
                </div>

                <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
                <div class="filter-group">
                    <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                    <select name="sort">
                        <option value="-date_placed" {% if request.GET.sort == '-date_placed' %}selected{% endif %}>–ü–æ –¥–∞—Ç–µ ‚Üì</option>
                        <option value="date_placed" {% if request.GET.sort == 'date_placed' %}selected{% endif %}>–ü–æ –¥–∞—Ç–µ ‚Üë</option>
                        <option value="-stake" {% if request.GET.sort == '-stake' %}selected{% endif %}>–ü–æ —Å—É–º–º–µ —Å—Ç–∞–≤–æ–∫ ‚Üì</option>
                        <option value="stake" {% if request.GET.sort == 'stake' %}selected{% endif %}>–ü–æ —Å—É–º–º–µ —Å—Ç–∞–≤–æ–∫ ‚Üë</option>
                        <option value="-profit" {% if request.GET.sort == '-profit' %}selected{% endif %}>–ü–æ –ø—Ä–∏–±—ã–ª–∏ ‚Üì</option>
                        <option value="profit" {% if request.GET.sort == 'profit' %}selected{% endif %}>–ü–æ –ø—Ä–∏–±—ã–ª–∏ ‚Üë</option>
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <a href="{% url 'app_bets:records' %}" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
            </div>
        </form>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Å—Ç–∞–≤–æ–∫ -->
    <div class="bets-list">
        {% for bet in bets %}
        <div class="bet-card
            {% if bet.result == 'WIN' %}win
            {% elif bet.result == 'LOSS' %}loss
            {% elif bet.result == 'REFUND' %}refund
            {% endif %}">

            <div class="bet-checkbox">
                <input type="checkbox" class="bet-select" value="{{ bet.id }}">
            </div>

            <div class="bet-content">
                <div class="bet-datetime">
                    <div class="bet-date">{{ bet.date_placed|date:"d.m.Y" }}</div>
                    <div class="bet-time">{{ bet.match_time }}</div>
                </div>

                <div class="bet-match">
                    <div class="bet-league">{{ bet.league.name }}</div>
                    <div class="bet-teams">
                        {{ bet.home_team.name }} <span class="vs">vs</span> {{ bet.away_team.name }}
                    </div>
                </div>

                <div class="bet-info">
                    <span class="bet-target {% if bet.recommended_target == 'over' %}target-over{% else %}target-under{% endif %}">
                        {{ bet.get_recommended_target_display }}
                    </span>
                    <span class="bet-odds">{{ bet.recommended_odds|floatformat:2 }}</span>
                    <span class="bet-stake">{{ bet.stake|floatformat:0 }} ‚ÇΩ</span>
                    <span class="bet-ev {% if bet.ev > 0 %}ev-positive{% elif bet.ev < 0 %}ev-negative{% endif %}">
                        EV: {{ bet.ev|floatformat:1 }}%
                    </span>
                </div>

                <div class="bet-result">
                    {% if bet.result %}
                    <span class="result-badge
                        {% if bet.result == 'WIN' %}result-win
                        {% elif bet.result == 'LOSS' %}result-loss
                        {% elif bet.result == 'REFUND' %}result-refund
                        {% endif %}">
                        {{ bet.get_result_display }}
                    </span>
                    {% endif %}

                    {% if bet.profit %}
                    <div class="bet-profit {% if bet.profit > 0 %}profit-positive{% elif bet.profit < 0 %}profit-negative{% endif %}">
                        {{ bet.profit|floatformat:0|cut:"-" }} ‚ÇΩ
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <i class="fa-solid fa-futbol"></i>
            <h3>–°—Ç–∞–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
        </div>
        {% endfor %}
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if is_paginated %}
    <div class="pagination-wrapper">
        <ul class="pagination">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1
                    {% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">¬´
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}
                    {% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">‚Äπ
                </a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}
                        {% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}
                    </a>
                </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}
                    {% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">‚Ä∫
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}
                    {% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">¬ª
                </a>
            </li>
            {% endif %}
        </ul>
    </div>
    {% endif %}
</div>

<!-- –§–æ—Ä–º–∞ –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π -->
<form id="bulkActionForm" method="post" action="{% url 'app_bets:bulk_bet_action' %}">
    {% csrf_token %}
    <input type="hidden" name="action" id="bulkActionInput">
    <input type="hidden" name="confirm" id="confirmInput">
</form>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-danger" id="confirmAction">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.bet-select');
    const applyBtn = document.getElementById('applyBulkAction');
    const actionSelect = document.getElementById('bulkAction');
    const form = document.getElementById('bulkActionForm');
    const modal = document.getElementById('confirmModal');
    const modalBody = document.getElementById('modalBody');
    const confirmBtn = document.getElementById('confirmAction');

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏
    function updateButtonState() {
        const checkedCount = document.querySelectorAll('.bet-select:checked').length;
        applyBtn.disabled = checkedCount === 0;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ —á–µ–∫–±–æ–∫—Å—ã
    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateButtonState);
    });

    // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"
    applyBtn.addEventListener('click', function() {
        const action = actionSelect.value;
        if (!action) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ');
            return;
        }

        // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã
        const selected = document.querySelectorAll('.bet-select:checked');

        if (selected.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Ç–∞–≤–∫—É');
            return;
        }

        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –æ—Ç —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Å–æ—Ö—Ä–∞–Ω—è–µ–º csrf –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è)
        while (form.children.length > 3) {
            form.removeChild(form.lastChild);
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º action
        document.getElementById('bulkActionInput').value = action;

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ ID
        selected.forEach(cb => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_bets';
            input.value = cb.value;
            form.appendChild(input);
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        if (action === 'delete') {
            modalBody.innerHTML = `
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å <strong>${selected.length}</strong> —Å—Ç–∞–≤–æ–∫?</p>
                <p class="text-danger">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</p>
            `;
        } else {
            const actionText = actionSelect.options[actionSelect.selectedIndex].text;
            modalBody.innerHTML = `
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${actionText.toLowerCase()} –¥–ª—è <strong>${selected.length}</strong> —Å—Ç–∞–≤–æ–∫?</p>
            `;
        }

        modal.classList.add('show');
    });

    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
    confirmBtn.onclick = function() {
        document.getElementById('confirmInput').value = 'true';
        form.submit();
    };

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    window.toggleFilters = function() {
        const form = document.getElementById('filterForm');
        const toggle = document.getElementById('filterToggle');
        if (form.style.display === 'none') {
            form.style.display = 'block';
            toggle.textContent = '‚ñº';
        } else {
            form.style.display = 'none';
            toggle.textContent = '‚ñ∂';
        }
    };

    window.closeModal = function() {
        modal.classList.remove('show');
    };

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            closeModal();
        }
    });
});
</script>
{% endblock %}