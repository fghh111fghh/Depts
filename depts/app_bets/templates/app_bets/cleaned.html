{% extends 'app_bets/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'app_bets/css/styles.css' %}">

<div class="ds-header-block">
    <h1><i class="fa-solid fa-chart-line"></i> Анализ матчей по калибровке</h1>
</div>

<!-- Кнопки экспорта и перехода к учёту -->
<div class="bets-sort-container" style="justify-content: flex-end;">
    <div class="bets-actions-wrapper" style="display: flex; gap: 10px;">
        {% if analysis_results %}
        <a href="{% url 'app_bets:export_cleaned' %}" class="bets-export-btn">
            <i class="fa-solid fa-file-excel"></i> В Excel
        </a>
        {% endif %}
        <a href="{% url 'app_bets:records' %}" class="bets-records-btn" style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        ">
            <i class="fa-solid fa-book"></i> Учёт ставок
            <span style="
                background: rgba(255,255,255,0.2);
                padding: 2px 8px;
                border-radius: 20px;
                font-size: 0.9rem;
                margin-left: 5px;
            ">журнал</span>
        </a>
    </div>
</div>

<div class="bets-results-container-full">
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% elif analysis_results %}
        {% for res in analysis_results %}
        <div class="bets-result-card">
            <div class="match-header-line">
                <div class="match-title-line">
                    <div class="match-time-title">
                        <span class="match-time">{{ res.time }}</span>
                        <strong class="match-name-large">{{ res.match }}</strong>
                    </div>
                    <div class="league-line">{{ res.league }}</div>
                </div>
                <div class="odds-line">
                    <div class="odd-box-line">
                        <div class="odd-label-line">ТБ 2.5</div>
                        <div class="odd-value-line">{{ res.odds_over|floatformat:2 }}</div>
                    </div>
                    <div class="odd-sep-line">|</div>
                    <div class="odd-box-line">
                        <div class="odd-label-line">ТМ 2.5</div>
                        <div class="odd-value-line">{{ res.odds_under|floatformat:2 }}</div>
                    </div>
                </div>
                <div class="verdict-line verdict-p1">
                    {{ res.target }} (EV +{{ res.ev }}%)
                </div>
            </div>

            <!-- Строка с вероятностями и кнопкой "Учесть" (без n) -->
            <div class="match-prob-row">
                <div class="prob-values">
                    <span><strong>Прогноз Пуассона:</strong> {{ res.poisson_prob }}%</span>
                    <span><strong>Фактическая вероятность:</strong> {{ res.actual_prob }}% (интервал {{ res.interval }})</span>
                </div>
                <a href="{% url 'app_bets:bet_create' %}?home_team_id={{ res.home_team_id }}&away_team_id={{ res.away_team_id }}&league_id={{ res.league_id }}&match_time={{ res.time }}&odds_over={{ res.odds_over }}&odds_under={{ res.odds_under }}&recommended_target={{ res.target_code }}&recommended_odds={{ res.recommended_odds }}&poisson_prob={{ res.poisson_prob }}&actual_prob={{ res.actual_prob }}&ev={{ res.ev }}&n_last_matches={{ res.n }}&interval={{ res.interval }}" class="bets-account-btn">
                    <i class="fa-solid fa-book"></i> Учесть
                </a>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="no-results">
            <i class="fa-solid fa-futbol no-results-icon"></i>
            <p class="no-results-text">Нет матчей с положительным EV</p>
        </div>
    {% endif %}
</div>

<!-- Добавим немного стилей для адаптивности -->
<style>
    .bets-actions-wrapper {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .bets-records-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .bets-records-btn:active {
        transform: translateY(0);
    }

    @media (max-width: 768px) {
        .bets-sort-container {
            justify-content: center !important;
        }

        .bets-actions-wrapper {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}