{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'app_bets/css/styles.css' %}">

<div class="bets-results-container-full">
    {% for res in cleaned_results %}
    <div class="bets-result-card">
        <!-- Верхняя строка -->
        <div class="match-header-line">
            <div class="match-title-line">
                <strong class="match-name-large">{{ res.match }}</strong>
                <div class="league-line">{{ res.league }}</div>
            </div>

            {% if res.odds %}
            <div class="odds-line">
                <div class="odd-box-line">
                    <div class="odd-label-line">P1</div>
                    <div class="odd-value-line">{{ res.odds.0|default:"-"|floatformat:2 }}</div>
                </div>
                <div class="odd-sep-line">|</div>
                <div class="odd-box-line">
                    <div class="odd-label-line">X</div>
                    <div class="odd-value-line">{{ res.odds.1|default:"-"|floatformat:2 }}</div>
                </div>
                <div class="odd-sep-line">|</div>
                <div class="odd-box-line">
                    <div class="odd-label-line">P2</div>
                    <div class="odd-value-line">{{ res.odds.2|default:"-"|floatformat:2 }}</div>
                </div>
            </div>
            {% endif %}

            <div class="verdict-line
                {% if res.verdict == 'СИГНАЛ: П1' %}verdict-p1
                {% elif res.verdict == 'СИГНАЛ: П2' %}verdict-p2
                {% elif res.verdict == 'СИГНАЛ: НИЧЬЯ' %}verdict-draw
                {% endif %}">
                {% if res.verdict == 'СИГНАЛ: П1' %}П1
                {% elif res.verdict == 'СИГНАЛ: П2' %}П2
                {% elif res.verdict == 'СИГНАЛ: НИЧЬЯ' %}НИЧЬЯ
                {% else %}{{ res.verdict }}
                {% endif %}
            </div>
        </div>

        <!-- Пуассон -->
        <div class="bets-info-row poisson-row">
            <div class="poisson-lambda">
                <span class="bets-stat-label">Коэф. Пуассона</span>
                <div class="lambda-values">
                    {% with lambda_parts=res.poisson_l|default:"0 : 0" %}
                    {% with parts=lambda_parts.split %}
                        <span class="lambda-home">{{ parts.0|default:"0" }}</span>
                        <span class="lambda-separator">:</span>
                        <span class="lambda-away">{{ parts.2|default:"0" }}</span>
                    {% endwith %}
                    {% endwith %}
                </div>
            </div>
            <div class="poisson-top-scores">
                <span class="bets-stat-label">Топ-5 счетов (Пуассон)</span>
                <div class="scores-list">
                    {% for item in res.poisson_top|slice:":5" %}
                    <div class="score-rectangle">
                        <span class="score-value">{{ item.score }}</span>
                        <span class="prob-value">{{ item.prob }}%</span>
                    </div>
                    {% empty %}
                    <div class="no-scores">Нет данных</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Статистика BTTS и Тотала -->
        <div class="bets-info-row poisson-stats-row">
            <div class="poisson-stat-box">
                <div class="stat-box-header">
                    <i class="fa-solid fa-futbol"></i> Обе забьют
                </div>
                <div class="stat-box-values">
                    <div class="stat-value stat-yes">
                        <div class="stat-label">Да</div>
                        <div class="stat-percent">{{ res.poisson_btts.yes|default:"0" }}%</div>
                    </div>
                    <div class="stat-value stat-no">
                        <div class="stat-label">Нет</div>
                        <div class="stat-percent">{{ res.poisson_btts.no|default:"0" }}%</div>
                    </div>
                </div>
            </div>

            <div class="poisson-stat-box">
                <div class="stat-box-header">
                    <i class="fa-solid fa-chart-line"></i> Тотал > 2.5
                </div>
                <div class="stat-box-values">
                    <div class="stat-value stat-yes">
                        <div class="stat-label">Да</div>
                        <div class="stat-percent">{{ res.poisson_over25.yes|default:"0" }}%</div>
                    </div>
                    <div class="stat-value stat-no">
                        <div class="stat-label">Нет</div>
                        <div class="stat-percent">{{ res.poisson_over25.no|default:"0" }}%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Twins - ИСПРАВЛЕНО -->
        <div class="bets-info-row twins-row">
            <div class="twins-count">
                <span class="bets-stat-label">Игр-близнецов (кэфы)</span>
                <span class="bets-stat-value twins-value">{{ res.twins_count }}</span>
            </div>
            <div class="twins-distribution">
                <span class="bets-stat-label">Вероятность по близнецам</span>
                <div style="display: flex; flex-direction: column; gap: 5px; margin-top: 5px;">
                    {% if res.twins_data %}
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #28a745; font-weight: 600;">П1</span>
                            <span style="color: #155724; font-weight: 700;">{{ res.twins_data.p1 }}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #856404; font-weight: 600;">X</span>
                            <span style="color: #856404; font-weight: 700;">{{ res.twins_data.x }}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #dc3545; font-weight: 600;">П2</span>
                            <span style="color: #721c24; font-weight: 700;">{{ res.twins_data.p2 }}%</span>
                        </div>
                    {% else %}
                        <span class="bets-stat-value dist-value">Нет данных</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- История встреч -->
        <div class="bets-info-row h2h-row">
            <div class="h2h-container">
                <div class="h2h-header">
                    <span class="bets-stat-label">Последние встречи (из {{ res.h2h_total }})</span>
                    <span class="h2h-count">
                        {% if res.h2h_list %}
                            {{ res.h2h_list|length }} матчей
                        {% else %}
                            0 матчей
                        {% endif %}
                    </span>
                </div>
                <div class="h2h-history-compact">
                    {% if res.h2h_list %}
                        {% for match in res.h2h_list|slice:":5" %}
                        <div class="h2h-item-compact">
                            <div class="h2h-date-compact">
                                {{ match.date|default:"-" }}
                            </div>
                            <div class="h2h-score-container">
                                {% if match.score %}
                                    {% if ":" in match.score %}
                                        {% with score_str=match.score|stringformat:"s" %}
                                            {% with home_goals=score_str|slice:":1" away_goals=score_str|slice:"2:" %}
                                                {% if home_goals|add:"0" > away_goals|add:"0" %}
                                                    <span class="h2h-score h2h-win">{{ match.score }}</span>
                                                {% elif home_goals|add:"0" < away_goals|add:"0" %}
                                                    <span class="h2h-score h2h-loss">{{ match.score }}</span>
                                                {% else %}
                                                    <span class="h2h-score h2h-draw">{{ match.score }}</span>
                                                {% endif %}
                                            {% endwith %}
                                        {% endwith %}
                                    {% else %}
                                        <span class="h2h-score">{{ match.score }}</span>
                                    {% endif %}
                                {% else %}
                                    <span class="h2h-score"> - </span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-h2h-data">Нет данных о встречах</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Паттерны - ИСПРАВЛЕНО -->
        <div class="bets-info-row pattern-row">
            <div class="pattern-container">
                <div class="pattern-big-font">
                    <span class="pattern-title-big">Исторический шаблон (последние 4 игры)</span>
                    <span class="pattern-stats-big">
                        совпадений: <strong>{{ res.pattern_data.count|default:"0" }}</strong>
                        <span class="pattern-sep-big">|</span>
                    </span>
                </div>

                {% if res.pattern_data and res.pattern_data.pattern %}
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                    <!-- Квадратики -->
                    <div class="pattern-badges-row">
                        {% for char in res.pattern_data.pattern %}
                            {% if char == 'В' %}
                            <span class="p-badge v-win">В</span>
                            {% elif char == 'П' %}
                            <span class="p-badge v-loss">П</span>
                            {% elif char == 'Н' %}
                            <span class="p-badge v-draw">Н</span>
                            {% elif char == '-' %}
                            <span class="p-separator">—</span>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <!-- Проценты цветные -->
                    <div style="display: flex; align-items: center; gap: 15px; font-size: 0.95rem; font-weight: 700;">
                        {% if res.pattern_data.p1 is not None %}
                        <span style="color: #28a745;">П1 {{ res.pattern_data.p1 }}%</span>
                        {% endif %}
                        {% if res.pattern_data.x is not None %}
                        <span style="color: #856404;">X {{ res.pattern_data.x }}%</span>
                        {% endif %}
                        {% if res.pattern_data.p2 is not None %}
                        <span style="color: #dc3545;">П2 {{ res.pattern_data.p2 }}%</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %}
    <div class="no-results">
        <h3>Нет результатов для отображения</h3>
        <p>Не найдено матчей с сигналами P1, P2 или X.</p>
    </div>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.lambda-values').forEach(function(container) {
        var text = container.textContent.trim();
        if (text.includes(':')) {
            var parts = text.split(':');
            if (parts.length >= 2) {
                container.innerHTML = '<span class="lambda-home">' + parts[0].trim() + '</span>' +
                                    '<span class="lambda-separator">:</span>' +
                                    '<span class="lambda-away">' + parts[1].trim() + '</span>';
            }
        }
    });

    document.querySelectorAll('.h2h-score').forEach(function(scoreElement) {
        var scoreText = scoreElement.textContent.trim();
        if (scoreText.includes(':')) {
            var parts = scoreText.split(':');
            if (parts.length === 2) {
                var home = parseInt(parts[0]) || 0;
                var away = parseInt(parts[1]) || 0;
                scoreElement.classList.remove('h2h-win', 'h2h-loss', 'h2h-draw');
                if (home > away) {
                    scoreElement.classList.add('h2h-win');
                } else if (home < away) {
                    scoreElement.classList.add('h2h-loss');
                } else {
                    scoreElement.classList.add('h2h-draw');
                }
            }
        }
    });
});
</script>
{% endblock %}