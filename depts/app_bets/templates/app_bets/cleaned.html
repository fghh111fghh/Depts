{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'app_bets/css/styles.css' %}">

<div class="bets-main-grid">
    <aside class="bets-input-pane">
        <h3>Анализатор</h3>
        <p>Результаты фильтрации по сигналам (P1, P2, X).</p>
        <a href="{% url 'app_bets:cleaned' %}" class="bets-btn-analyze"
           style="display: block; text-align: center; text-decoration: none;">Новый анализ</a>

    </aside>

    <main class="bets-results-container">
        {% for res in cleaned_results %}
        <div class="bets-result-card">
            <div class="bets-result-header">
                <strong>{{ res.match }}</strong>
                <span class="bets-stat-label" style="color: #2c3e50;">{{ res.league }}</span>
            </div>

            <div class="bets-info-row">
                <div style="min-width: 140px;">
                    <span class="bets-stat-label">По методу Пуассона</span>
                    <span class="bets-stat-value">{{ res.poisson_l }}</span>
                </div>
                <div>
                    <span class="bets-stat-label">5 самых вероятных счетов по методу Пуассона</span>
                    <div class="scores-list">
                        {% for item in res.poisson_top|slice:":5" %}
                        <div class="score-badge">
                            <span style="font-weight: 800; font-size: 1.1rem;">{{ item.score }}</span>
                            <span class="prob-value">{{ item.prob }}%</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="bets-info-row"
                 style="background: #f1f8ff; border: 1px solid #d1e9ff; padding: 12px; border-radius: 4px;">
                <div style="min-width: 140px;">
                    <span class="bets-stat-label">Игр-близнецов (кэфы)</span>
                    <span class="bets-stat-value">{{ res.twins_count }}</span>
                </div>
                <div style="flex-grow: 1;">
                    <span class="bets-stat-label">Вероятность на основе игр-близнецов</span>
                    <span class="bets-stat-value" style="color: #0056b3; font-size: 1.1rem;">
                    {{ res.twins_dist }}
                </span>
                </div>
            </div>

            <div class="bets-info-row" style="border-bottom: 1px solid #f0f0f0;">
                <div style="width: 100%;">
                    <span class="bets-stat-label">Последние 5 личных встреч (из {{ res.h2h_total }})</span>
                    <div class="h2h-history">
                        {% for match in res.h2h_list|slice:":5" %}
                        <div class="h2h-item">
                            <span style="color: #888; width: 70px; display: inline-block;">{{ match.date }}</span>
                            <span style="font-weight: 600;">{{ match.score }}</span>
                            <span style="margin-left: 10px; color: #555;">{{ res.match }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="bets-info-row"
                 style="border-bottom: none; background: #fcfcfc; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid #eee;">
                <div style="width: 100%;">
                    <span class="bets-stat-label" style="color: #555; font-weight: 800; margin-bottom: 10px;">Исторический шаблон по последним 4 играм</span>

                    {% if res.pattern_data.pattern %}
                    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 10px;">

                        <div class="pattern-badges-row">
                            {% for char in res.pattern_data.pattern %}
                            {% if char == 'В' %}
                            <span class="p-badge v-win">В</span>
                            {% elif char == 'П' %}
                            <span class="p-badge v-loss">П</span>
                            {% elif char == 'Н' %}
                            <span class="p-badge v-draw">Н</span>
                            {% elif char == '-' %}
                            <span class="p-separator">—</span>
                            {% endif %}
                            {% endfor %}
                        </div>

                        <div style="display: flex; gap: 25px; align-items: center; background: #fff; padding: 8px 12px; border-radius: 6px; border: 1px dashed #ddd; width: fit-content;">
                            <div>
                                <span class="bets-stat-label" style="font-size: 0.7rem;">Найдено совпадений:</span>
                                <span class="bets-stat-value" style="color: #333;">{{ res.pattern_data.count }}</span>
                            </div>
                            <div>
                                <span class="bets-stat-label" style="font-size: 0.7rem;">Итог по истории:</span>
                                <span class="bets-stat-value" style="color: #d35400; font-size: 1.1rem;">
                            {{ res.pattern_data.dist }}
                        </span>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div style="margin-top: 5px; color: #999; font-size: 0.85rem;">Данных недостаточно</div>
                    {% endif %}
                </div>
            </div>

            <div class="bets-verdict-box" style="margin-top: 15px;">
                {{ res.verdict|upper }}
            </div>
        </div>
        {% endfor %}
    </main>
</div>
{% endblock %}