{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'app_bets/css/styles.css' %}">

<div class="ds-header-block">
    <h1><i class="fa-solid fa-chart-line"></i> Анализ матчей по калибровке</h1>
</div>

<!-- Кнопка экспорта -->
<div class="bets-sort-container" style="justify-content: flex-end;">
    <div class="bets-actions-wrapper">
        {% if analysis_results %}
        <a href="{% url 'app_bets:export_cleaned' %}" class="bets-export-btn">
            <i class="fa-solid fa-file-excel"></i> В Excel
        </a>
        {% endif %}
    </div>
</div>

<div class="bets-results-container-full">
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% elif analysis_results %}
        {% for res in analysis_results %}
        <div class="bets-result-card">
            <div class="match-header-line">
                <div class="match-title-line">
                    <div class="match-time-title">
                        <span class="match-time">{{ res.time }}</span>
                        <strong class="match-name-large">{{ res.match }}</strong>
                    </div>
                    <div class="league-line">{{ res.league }}</div>
                </div>
                <div class="odds-line">
                    <div class="odd-box-line">
                        <div class="odd-label-line">ТБ 2.5</div>
                        <div class="odd-value-line">{{ res.odds_over|floatformat:2 }}</div>
                    </div>
                    <div class="odd-sep-line">|</div>
                    <div class="odd-box-line">
                        <div class="odd-label-line">ТМ 2.5</div>
                        <div class="odd-value-line">{{ res.odds_under|floatformat:2 }}</div>
                    </div>
                </div>
                <div class="verdict-line verdict-p1">
                    {{ res.target }} (EV +{{ res.ev }}%)
                </div>
            </div>

            <!-- Строка с вероятностями и кнопкой "Учесть" (без n) -->
            <div class="match-prob-row">
                <div class="prob-values">
                    <span><strong>Прогноз Пуассона:</strong> {{ res.poisson_prob }}%</span>
                    <span><strong>Фактическая вероятность:</strong> {{ res.actual_prob }}% (интервал {{ res.interval }})</span>
                </div>
                <a href="{% url 'app_bets:bet_create' %}?home_team_id={{ res.home_team_id }}&away_team_id={{ res.away_team_id }}&league_id={{ res.league_id }}&match_time={{ res.time }}&odds_over={{ res.odds_over }}&odds_under={{ res.odds_under }}&recommended_target={{ res.target_code }}&recommended_odds={{ res.recommended_odds }}&poisson_prob={{ res.poisson_prob }}&actual_prob={{ res.actual_prob }}&ev={{ res.ev }}&n_last_matches={{ res.n }}&interval={{ res.interval }}" class="bets-account-btn">
                    <i class="fa-solid fa-book"></i> Учесть
                </a>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="no-results">
            <i class="fa-solid fa-futbol no-results-icon"></i>
            <p class="no-results-text">Нет матчей с положительным EV</p>
        </div>
    {% endif %}
</div>
{% endblock %}