{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'app_bets/css/styles.css' %}">

<div class="bets-results-container-full">
    {% for res in cleaned_results %}
    <div class="bets-result-card">
        <!-- Верхняя строка -->
        <div class="match-header-line">
            <div class="match-title-line">
                <strong class="match-name-large">{{ res.match }}</strong>
                <div class="league-line">{{ res.league }}</div>
            </div>

            {% if res.odds %}
            <div class="odds-line">
                <div class="odd-box-line">
                    <div class="odd-label-line">P1</div>
                    <div class="odd-value-line">{{ res.odds.0|default:"-"|floatformat:2 }}</div>
                </div>
                <div class="odd-sep-line">|</div>
                <div class="odd-box-line">
                    <div class="odd-label-line">X</div>
                    <div class="odd-value-line">{{ res.odds.1|default:"-"|floatformat:2 }}</div>
                </div>
                <div class="odd-sep-line">|</div>
                <div class="odd-box-line">
                    <div class="odd-label-line">P2</div>
                    <div class="odd-value-line">{{ res.odds.2|default:"-"|floatformat:2 }}</div>
                </div>
            </div>
            {% endif %}

            <div class="verdict-line
                {% if res.verdict == 'СИГНАЛ: П1' %}verdict-p1
                {% elif res.verdict == 'СИГНАЛ: П2' %}verdict-p2
                {% elif res.verdict == 'СИГНАЛ: НИЧЬЯ' %}verdict-draw
                {% endif %}">
                {% if res.verdict == 'СИГНАЛ: П1' %}П1
                {% elif res.verdict == 'СИГНАЛ: П2' %}П2
                {% elif res.verdict == 'СИГНАЛ: НИЧЬЯ' %}НИЧЬЯ
                {% else %}{{ res.verdict }}
                {% endif %}
            </div>
        </div>

        <!-- Пуассон -->
        <div class="bets-info-row poisson-row">
            <div class="poisson-lambda">
                <span class="bets-stat-label">Коэф. Пуассона</span>
                <div class="lambda-values">
                    {% with lambda_parts=res.poisson_l|default:"0 : 0" %}
                    {% with parts=lambda_parts.split %}
                        <span class="lambda-home">{{ parts.0|default:"0" }}</span>
                        <span class="lambda-separator">:</span>
                        <span class="lambda-away">{{ parts.2|default:"0" }}</span>
                    {% endwith %}
                    {% endwith %}
                </div>
            </div>
            <div class="poisson-top-scores">
                <span class="bets-stat-label">Топ-5 счетов (Пуассон)</span>
                <div class="scores-list">
                    {% for item in res.poisson_top|slice:":5" %}
                    <div class="score-rectangle">
                        <span class="score-value">{{ item.score }}</span>
                        <span class="prob-value">{{ item.prob }}%</span>
                    </div>
                    {% empty %}
                    <div class="no-scores">Нет данных</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Статистика BTTS и Тотала -->
        <div class="bets-info-row poisson-stats-row">
            <div class="poisson-stat-box">
                <div class="stat-box-header">
                    <i class="fa-solid fa-futbol"></i> Обе забьют
                </div>
                <div class="stat-box-values">
                    <div class="stat-value stat-yes">
                        <span class="stat-label">Да</span>
                        <span class="stat-percent">{{ res.poisson_btts.yes|default:"0" }}%</span>
                    </div>
                    <div class="stat-value stat-no">
                        <span class="stat-label">Нет</span>
                        <span class="stat-percent">{{ res.poisson_btts.no|default:"0" }}%</span>
                    </div>
                </div>
            </div>

            <div class="poisson-stat-box">
                <div class="stat-box-header">
                    <i class="fa-solid fa-chart-line"></i> Тотал > 2.5
                </div>
                <div class="stat-box-values">
                    <div class="stat-value stat-yes">
                        <span class="stat-label">Да</span>
                        <span class="stat-percent">{{ res.poisson_over25.yes|default:"0" }}%</span>
                    </div>
                    <div class="stat-value stat-no">
                        <span class="stat-label">Нет</span>
                        <span class="stat-percent">{{ res.poisson_over25.no|default:"0" }}%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Twins -->
        <div class="bets-info-row twins-row">
            <div class="twins-count">
                <span class="bets-stat-label">Игр-близнецов (кэфы)</span>
                <span class="bets-stat-value twins-value">{{ res.twins_count }}</span>
            </div>
            <div class="twins-distribution">
                <span class="bets-stat-label">Вероятность по близнецам</span>
                <div class="twins-probabilities" style="margin-top: 5px;">
                    {% if res.twins_data %}
                        <div class="twins-prob-item p1" style="justify-content: space-between;">
                            <span class="twins-prob-label p1">П1</span>
                            <span class="twins-prob-value p1">{{ res.twins_data.p1 }}%</span>
                        </div>
                        <div class="twins-prob-item x" style="justify-content: space-between;">
                            <span class="twins-prob-label x">X</span>
                            <span class="twins-prob-value x">{{ res.twins_data.x }}%</span>
                        </div>
                        <div class="twins-prob-item p2" style="justify-content: space-between;">
                            <span class="twins-prob-label p2">П2</span>
                            <span class="twins-prob-value p2">{{ res.twins_data.p2 }}%</span>
                        </div>
                    {% else %}
                        <span class="twins-no-data">Нет данных</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- История встреч - как в главном шаблоне -->
        <div class="h2h-block" style="margin-top: 15px;">
            <div class="h2h-header">
                <span class="h2h-title">
                    <i class="fa-solid fa-history"></i> Личные встречи (в этом статусе)
                </span>
                <span class="h2h-total">
                    Найдено: {{ res.h2h_total }}
                </span>
            </div>

            <div class="h2h-list">
                {% for h in res.h2h_list|slice:":5" %}
                <div class="h2h-item">
                    <span class="h2h-date">{{ h.date }}</span>
                    <span class="h2h-score
                        {% with score_parts=h.score|stringformat:"s" %}
                            {% with home=score_parts|slice:":1" away=score_parts|slice:"2:" %}
                                {% if home|add:"0" > away|add:"0" %}win
                                {% elif home|add:"0" < away|add:"0" %}loss
                                {% else %}draw
                                {% endif %}
                            {% endwith %}
                        {% endwith %}">
                        {{ h.score }}
                    </span>
                </div>
                {% empty %}
                <span class="h2h-empty">Игр в таком статусе не найдено</span>
                {% endfor %}
            </div>
        </div>

        <!-- Исторический шаблон - КАК В ГЛАВНОМ ШАБЛОНЕ -->
        <div class="pattern-block" style="margin-top: 15px;">
            <div class="pattern-header">
                <span class="pattern-title">
                    <i class="fa-solid fa-clock-rotate-left"></i> Исторический шаблон (серия x4)
                </span>
                {% if res.pattern_data.count %}
                <span class="pattern-count">
                    Найдено: {{ res.pattern_data.count }}
                </span>
                {% endif %}
            </div>

            {% if res.pattern_data.pattern %}
            <div class="pattern-content">
                <!-- Квадратики -->
                <div class="pattern-badges-row">
                    {% for char in res.pattern_data.pattern %}
                        {% if char == 'В' %}
                        <span class="p-badge v-win">В</span>
                        {% elif char == 'П' %}
                        <span class="p-badge v-loss">П</span>
                        {% elif char == 'Н' %}
                        <span class="p-badge v-draw">Н</span>
                        {% elif char == '-' %}
                        <span class="p-separator">—</span>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Проценты -->
                <div class="pattern-percents">
                    {% if res.pattern_data.p1 is not None %}
                    <span class="pattern-percent-item p1">П1 {{ res.pattern_data.p1 }}%</span>
                    {% endif %}
                    {% if res.pattern_data.x is not None %}
                    <span class="pattern-percent-item x">X {{ res.pattern_data.x }}%</span>
                    {% endif %}
                    {% if res.pattern_data.p2 is not None %}
                    <span class="pattern-percent-item p2">П2 {{ res.pattern_data.p2 }}%</span>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="pattern-no-data">{{ res.pattern_data }}</div>
            {% endif %}
        </div>
    </div>
    {% empty %}
    <div class="no-results">
        <h3>Нет результатов для отображения</h3>
        <p>Не найдено матчей с сигналами P1, P2 или X.</p>
    </div>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.lambda-values').forEach(function(container) {
        var text = container.textContent.trim();
        if (text.includes(':')) {
            var parts = text.split(':');
            if (parts.length >= 2) {
                container.innerHTML = '<span class="lambda-home">' + parts[0].trim() + '</span>' +
                                    '<span class="lambda-separator">:</span>' +
                                    '<span class="lambda-away">' + parts[1].trim() + '</span>';
            }
        }
    });

    document.querySelectorAll('.h2h-score').forEach(function(scoreElement) {
        var scoreText = scoreElement.textContent.trim();
        if (scoreText.includes(':')) {
            var parts = scoreText.split(':');
            if (parts.length === 2) {
                var home = parseInt(parts[0]) || 0;
                var away = parseInt(parts[1]) || 0;
                scoreElement.classList.remove('win', 'loss', 'draw');
                if (home > away) {
                    scoreElement.classList.add('win');
                } else if (home < away) {
                    scoreElement.classList.add('loss');
                } else {
                    scoreElement.classList.add('draw');
                }
            }
        }
    });
});
</script>
{% endblock %}