{% extends 'base.html' %}
{% load static %}
{% load bet_filters %}

{% block content %}
<link rel="stylesheet" href="{% static 'app_bets/css/styles.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">

<div class="container mt-4 bet-form">
    <!-- Блок сообщений -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}success{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <h2 class="mb-3">Добавление ставки</h2>

    <!-- Общие ошибки формы -->
    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
                {{ error }}
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" id="bet-form">
        {% csrf_token %}
        <div class="row">
            <!-- Левая колонка -->
            <div class="col-md-6">
                <!-- Блок Матч -->
                <div class="card mb-3">
                    <div class="card-header bg-match fw-bold">
                        <h4 class="mb-0 fs-5">Матч</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.match_time.label_tag }}
                            {{ form.match_time }}
                            {% if form.match_time.errors %}
                                <div class="text-danger small">{{ form.match_time.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.home_team.label_tag }}
                            {{ form.home_team }}
                            {% if form.home_team.errors %}
                                <div class="text-danger small">{{ form.home_team.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.away_team.label_tag }}
                            {{ form.away_team }}
                            {% if form.away_team.errors %}
                                <div class="text-danger small">{{ form.away_team.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {{ form.league.label_tag }}
                            {{ form.league }}
                            {% if form.league.errors %}
                                <div class="text-danger small">{{ form.league.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Блок Прогноз и калибровка -->
                <div class="card mb-3">
                    <div class="card-header bg-prediction fw-bold">
                        <h4 class="mb-0 fs-5">Прогноз и калибровка</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.poisson_prob.label_tag }}
                                {{ form.poisson_prob }}
                                {% if form.poisson_prob.errors %}
                                    <div class="text-danger small">{{ form.poisson_prob.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.actual_prob.label_tag }}
                                {{ form.actual_prob }}
                                {% if form.actual_prob.errors %}
                                    <div class="text-danger small">{{ form.actual_prob.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.ev.label_tag }}
                                {{ form.ev }}
                                {% if form.ev.errors %}
                                    <div class="text-danger small">{{ form.ev.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.interval.label_tag }}
                                {{ form.interval }}
                                {% if form.interval.errors %}
                                    <div class="text-danger small">{{ form.interval.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Правая колонка - Параметры ставки -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-params fw-bold">
                        <h4 class="mb-0 fs-5">Параметры ставки</h4>
                    </div>
                    <div class="card-body">
                        <!-- Банк до ставки -->
                        <div class="mb-3">
                            {{ form.bank_before.label_tag }}
                            <span class="form-control bg-light">{{ form.initial.bank_before|thousand_separator }}</span>
                            <input type="hidden" name="bank_before" value="{{ form.initial.bank_before }}" id="id_bank_before">
                            {% if form.bank_before.errors %}
                                <div class="text-danger small">{{ form.bank_before.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Дата расчёта -->
                        <div class="mb-3">
                            {{ form.settled_at.label_tag }}
                            {{ form.settled_at }}
                            {% if form.settled_at.errors %}
                                <div class="text-danger small">{{ form.settled_at.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Доля Келли -->
                        <div class="mb-3">
                            {{ form.fractional_kelly.label_tag }}
                            {{ form.fractional_kelly }}
                            {% if form.fractional_kelly.errors %}
                                <div class="text-danger small">{{ form.fractional_kelly.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Сумма ставки -->
                        <div class="mb-3">
                            {{ form.stake.label_tag }}
                            <div class="input-group">
                                <input type="text" class="form-control" id="id_stake_display" value="{{ form.initial.stake|default:'0' }}">
                                <input type="hidden" name="stake" id="id_stake" value="{{ form.initial.stake|default:'0' }}">
                            </div>
                            {% if form.stake.errors %}
                                <div class="text-danger small">{{ form.stake.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Коэф. на исход -->
                        <div class="mb-3">
                            {{ form.recommended_odds.label_tag }}
                            {{ form.recommended_odds }}
                            {% if form.recommended_odds.errors %}
                                <div class="text-danger small">{{ form.recommended_odds.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Рекомендуемый исход -->
                        <div class="mb-3">
                            {{ form.recommended_target.label_tag }}
                            {{ form.recommended_target }}
                            {% if form.recommended_target.errors %}
                                <div class="text-danger small">{{ form.recommended_target.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Результат -->
                        <div class="mb-3">
                            {{ form.result.label_tag }}
                            {{ form.result }}
                            {% if form.result.errors %}
                                <div class="text-danger small">{{ form.result.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Кнопки в правой колонке -->
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">Сохранить</button>
                            <a href="{% url 'app_bets:cleaned' %}" class="btn btn-secondary ms-2">Отмена</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {{ form.odds_over }}
        {{ form.odds_under }}
        {{ form.n_last_matches }}
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const bankInput = document.getElementById('id_bank_before');
    const oddsInput = document.getElementById('id_recommended_odds');
    const probInput = document.getElementById('id_actual_prob');
    const kellySelect = document.getElementById('id_fractional_kelly');
    const stakeInput = document.getElementById('id_stake');
    const stakeDisplay = document.getElementById('id_stake_display');

    function getFloatValue(element) {
        if (!element || !element.value) return 0;
        return parseFloat(element.value.toString().replace(/\s/g, '').replace(',', '.')) || 0;
    }

    function roundToHundreds(value) {
        return Math.round(value / 100) * 100;
    }

    function formatNumberWithSpaces(value) {
        return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }

    function calculateStake() {
        const bank = getFloatValue(bankInput);
        const odds = getFloatValue(oddsInput);
        const prob = getFloatValue(probInput);
        const fraction = parseFloat(kellySelect.value) || 0;

        if (odds > 1 && prob > 0 && prob < 100) {
            const p = prob / 100;
            const fullKelly = (p * odds - 1) / (odds - 1);
            const limitedKelly = Math.max(0, Math.min(fullKelly, 1));
            const stake = bank * limitedKelly * fraction;
            const roundedStake = roundToHundreds(stake);

            if (!stakeDisplay._userModified) {
                stakeInput.value = roundedStake;
                stakeDisplay.value = formatNumberWithSpaces(roundedStake);
            }
        } else {
            if (!stakeDisplay._userModified) {
                stakeInput.value = 0;
                stakeDisplay.value = '0';
            }
        }
    }

    stakeDisplay.addEventListener('input', function() {
        stakeDisplay._userModified = true;
        const rawValue = this.value.replace(/\s/g, '');
        stakeInput.value = rawValue;
    });

    function recalcWithFlag() {
        stakeDisplay._userModified = false;
        calculateStake();
    }

    bankInput.addEventListener('input', recalcWithFlag);
    oddsInput.addEventListener('input', recalcWithFlag);
    probInput.addEventListener('input', recalcWithFlag);
    kellySelect.addEventListener('change', recalcWithFlag);

    stakeDisplay._userModified = false;
    calculateStake();
});
</script>
{% endblock %}