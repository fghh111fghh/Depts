{% extends 'app_bets/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'app_bets/css/pages/bets_main.css' %}">

<!-- КНОПКА ЭКСПОРТ + ФИЛЬТРЫ -->
<div class="bets-sort-container">
    <div class="bets-actions-wrapper">
        {% if results %}
        <a href="{% url 'app_bets:export_excel' %}" class="bets-export-btn">
            <i class="fa-solid fa-file-excel"></i> В Excel
        </a>
        {% endif %}
    </div>

    {% if results %}
    <div class="bets-sort-wrapper">
        <span class="bets-sort-label">Сортировка:</span>
        <form method="get" action="." class="bets-sort-form">
            <button type="submit" name="sort" value="default"
                    class="bets-sort-btn {% if current_sort == 'default' or not current_sort %}active{% endif %}">
                По умолч.
            </button>
            <button type="submit" name="sort" value="btts_desc"
                    class="bets-sort-btn {% if current_sort == 'btts_desc' %}active{% endif %}">
                ОЗ ↓
            </button>
            <button type="submit" name="sort" value="over25_desc"
                    class="bets-sort-btn {% if current_sort == 'over25_desc' %}active{% endif %}">
                б2.5 ↓
            </button>
            <button type="submit" name="sort" value="twins_p1_desc"
                    class="bets-sort-btn {% if current_sort == 'twins_p1_desc' %}active{% endif %}">
                Близнецы ↓
            </button>
            <button type="submit" name="sort" value="pattern_p1_desc"
                    class="bets-sort-btn {% if current_sort == 'pattern_p1_desc' %}active{% endif %}">
                История ↓
            </button>
        </form>
    </div>
    {% endif %}
</div>

<div class="ds-header-block">
    <h1><i class="fa-solid fa-microchip"></i> Векторный Анализ</h1>
</div>

<div class="bets-main-grid">
    <!-- ЛЕВАЯ КОЛОНКА -->
    <div class="bets-left-col">
        <div class="bets-input-pane">
            <form method="post" action=".">
                {% csrf_token %}
                <input type="hidden" name="sort" value="{{ current_sort }}">
                <button type="submit" class="bets-btn-analyze">Рассчитать вероятность</button>

                {% if results %}
                <div class="bets-counters">
                    <div class="bets-counters-container">
                        <div class="bets-counter-item">
                            <i class="fa-solid fa-calculator bets-counter-icon calculator"></i>
                            <span class="bets-counter-label">Рассчитано матчей:</span>
                            <span class="bets-counter-value blue">{{ results|length }}</span>
                        </div>

                        {% if unknown_teams %}
                        <div class="bets-counter-divider"></div>
                        <div class="bets-counter-item">
                            <i class="fa-solid fa-graduation-cap bets-counter-icon graduation"></i>
                            <span class="bets-counter-label">Привязать команды:</span>
                            <span class="bets-counter-value orange">{{ unknown_teams|length }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <label class="bets-input-label">Ввод данных:</label>
                <textarea name="matches_text" class="bets-textarea" rows="18"
                          placeholder="Пример формата:
Реал Овьедо
Малага
2.10
3.10
3.80">{{ raw_text }}</textarea>
            </form>
        </div>

        {% if unknown_teams %}
        <div class="bets-unknown-section">
            <h4 class="bets-unknown-title">
                <i class="fa-solid fa-graduation-cap"></i> Обучение системы
                <span class="bets-unknown-badge">{{ unknown_teams|length }}</span>
            </h4>
            {% for name in unknown_teams %}
            <form method="post" action="." class="bets-alias-form">
                {% csrf_token %}
                <input type="hidden" name="matches_text" value="{{ raw_text }}">
                <input type="hidden" name="alias_name" value="{{ name }}">
                <input type="hidden" name="sort" value="{{ current_sort }}">
                <div class="bets-alias-name">{{ name }}</div>
                <select name="team_id" required class="bets-alias-select">
                    <option value="">-- выбери из базы --</option>
                    {% for team in all_teams %}
                    <option value="{{ team.id }}">{{ team.name }}</option>
                    {% endfor %}
                </select>
                <button type="submit" name="create_alias" class="bets-alias-btn">
                    Сохранить привязку
                </button>
            </form>
            {% endfor %}
        </div>
        {% endif %}

        <div class="bets-csv-section">
            <form method="post" action="{% url 'app_bets:upload_csv' %}">
                {% csrf_token %}
                <label class="bets-csv-label">
                    <i class="fa-solid fa-folder-open"></i> Локальная папка (import_data):
                </label>
                <p class="bets-csv-description">
                    Положить CSV файлы в папку import_data и нажать кнопку.
                </p>
                <button type="submit" name="sync_files" class="bets-csv-btn">
                    Синхронизировать базу
                </button>

                {% if import_message %}
                <div class="bets-import-result {{ import_status }}">
                    <h4 class="bets-import-title {{ import_status }}">
                        <i class="fa-solid fa-file-import"></i> Результат импорта
                    </h4>
                    <pre class="bets-import-message">{{ import_message }}</pre>
                    {% if import_added > 0 or import_skipped > 0 or import_errors > 0 %}
                    <div class="bets-import-details">
                        <i class="fa-solid fa-chart-bar"></i> Детали:
                        Добавлено: <strong>{{ import_added }}</strong>,
                        Пропущено: <strong>{{ import_skipped }}</strong>,
                        Ошибок: <strong>{{ import_errors }}</strong>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- ПРАВАЯ КОЛОНКА (РЕЗУЛЬТАТЫ) -->
    <div class="bets-results-area">
        {% if results %}
        {% for res in results %}
        <div class="bets-result-card">
            <!-- Верхняя строка -->
            <div class="match-header-line">
                <div class="match-title-line">
                    <strong class="match-name-large">{{ res.match }}</strong>
                    <div class="league-line">{{ res.league }}</div>
                </div>

                {% if res.odds %}
                <div class="odds-line">
                    <div class="odd-box-line">
                        <div class="odd-label-line">P1</div>
                        <div class="odd-value-line">{{ res.odds.0|default:"-"|floatformat:2 }}</div>
                    </div>
                    <div class="odd-sep-line">|</div>
                    <div class="odd-box-line">
                        <div class="odd-label-line">X</div>
                        <div class="odd-value-line">{{ res.odds.1|default:"-"|floatformat:2 }}</div>
                    </div>
                    <div class="odd-sep-line">|</div>
                    <div class="odd-box-line">
                        <div class="odd-label-line">P2</div>
                        <div class="odd-value-line">{{ res.odds.2|default:"-"|floatformat:2 }}</div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Пуассон и Близнецы -->
            <div class="poisson-twins-grid">
                <div class="poisson-main-block">
                    <h4 class="poisson-title">
                        <i class="fa-solid fa-calculator"></i> Пуассон: {{ res.poisson_l }}
                    </h4>

                    <div class="scores-list">
                        {% for s in res.poisson_top|slice:":5" %}
                            {% with score_parts=s.score|stringformat:"s" %}
                                {% with home=score_parts|slice:":1" away=score_parts|slice:"2:" %}
                                    <div class="score-rectangle
                                        {% if home|add:'0' > away|add:'0' %}home-win
                                        {% elif home|add:'0' < away|add:'0' %}away-win
                                        {% else %}draw
                                        {% endif %}">
                                        <span class="score-value">{{ s.score }}</span>
                                        <span class="prob-value">{{ s.prob|floatformat:1 }}%</span>
                                    </div>
                                {% endwith %}
                            {% endwith %}
                        {% endfor %}
                    </div>

                    <div class="btts-total-container">
                        <div class="btts-box">
                            <div class="btts-label">Обе забьют</div>
                            <div class="btts-values">
                                <div><span class="btts-yes">{{ res.poisson_btts.yes|floatformat:1 }}%</span></div>
                                <div><span class="btts-no">{{ res.poisson_btts.no|floatformat:1 }}%</span></div>
                            </div>
                        </div>
                        <div class="total-box">
                            <div class="total-label">Тотал > 2.5</div>
                            <div class="total-values">
                                <div><span class="total-yes">{{ res.poisson_over25.yes|floatformat:1 }}%</span></div>
                                <div><span class="total-no">{{ res.poisson_over25.no|floatformat:1 }}%</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="twins-main-block">
                    <div class="twins-header">
                        <h4 class="twins-title">
                            <i class="fa-solid fa-copy"></i> Близнецы (кэфы)
                        </h4>
                        <span class="twins-count-value">{{ res.twins_count }}</span>
                    </div>

                    <div class="twins-probabilities">
                        {% if res.twins_data %}
                        <div class="twins-prob-item p1">
                            <span class="twins-prob-label p1">П1</span>
                            <span class="twins-prob-value p1">{{ res.twins_data.p1 }}%</span>
                        </div>
                        <div class="twins-prob-item x">
                            <span class="twins-prob-label x">X</span>
                            <span class="twins-prob-value x">{{ res.twins_data.x }}%</span>
                        </div>
                        <div class="twins-prob-item p2">
                            <span class="twins-prob-label p2">П2</span>
                            <span class="twins-prob-value p2">{{ res.twins_data.p2 }}%</span>
                        </div>
                        {% else %}
                        <div class="twins-no-data">Нет данных по близнецам</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Исторический анализ -->
            {% if res.historical_total %}
            <div class="historical-total-block">
                <div class="historical-total-header">
                    <span class="historical-total-title">
                        <i class="fa-solid fa-chart-simple"></i> Исторический анализ
                    </span>
                    <span class="historical-total-label">Тотал больше 2,5</span>
                    <span class="historical-total-value">{{ res.historical_total.over_25 }}%</span>
                </div>
            </div>
            {% endif %}

            <!-- Исторический шаблон -->
            <div class="pattern-block">
                <div class="pattern-header">
                    <span class="pattern-title">
                        <i class="fa-solid fa-clock-rotate-left"></i> Исторический шаблон (серия x4)
                    </span>
                    {% if res.pattern_data and res.pattern_data.count %}
                    <span class="pattern-count">Найдено: {{ res.pattern_data.count }}</span>
                    {% endif %}
                </div>

                <div class="pattern-content">
                    <div class="pattern-badges-row">
                        {% for char in res.current_h_form %}
                            {% if char == 'В' %}
                                <span class="p-badge v-win">В</span>
                            {% elif char == 'П' %}
                                <span class="p-badge v-loss">П</span>
                            {% elif char == 'Н' %}
                                <span class="p-badge v-draw">Н</span>
                            {% endif %}
                        {% endfor %}
                        <span class="p-separator">—</span>
                        {% for char in res.current_a_form %}
                            {% if char == 'В' %}
                                <span class="p-badge v-win">В</span>
                            {% elif char == 'П' %}
                                <span class="p-badge v-loss">П</span>
                            {% elif char == 'Н' %}
                                <span class="p-badge v-draw">Н</span>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div class="pattern-percents">
                        {% if res.pattern_data and res.pattern_data.p1 is not None %}
                            <span class="pattern-percent-item p1">П1 {{ res.pattern_data.p1 }}%</span>
                            <span class="pattern-percent-item x">X {{ res.pattern_data.x }}%</span>
                            <span class="pattern-percent-item p2">П2 {{ res.pattern_data.p2 }}%</span>
                        {% else %}
                            <span class="pattern-no-data">Нет данных</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Личные встречи -->
            <div class="h2h-block">
                <div class="h2h-header">
                    <span class="h2h-title">
                        <i class="fa-solid fa-history"></i> Личные встречи (в этом статусе)
                    </span>
                    <span class="h2h-total">Найдено: {{ res.h2h_total }}</span>
                </div>

                <div class="h2h-grid">
                    {% for h in res.h2h_list|slice:":5" %}
                    <div class="h2h-card">
                        <span class="h2h-date">{{ h.date }}</span>
                        {% with score_parts=h.score|stringformat:"s" %}
                            {% with home=score_parts|slice:":1" away=score_parts|slice:"2:" %}
                                <span class="h2h-score
                                    {% if home|add:'0' > away|add:'0' %}win
                                    {% elif home|add:'0' < away|add:'0' %}loss
                                    {% else %}draw
                                    {% endif %}">
                                    {{ h.score }}
                                </span>
                            {% endwith %}
                        {% endwith %}
                    </div>
                    {% empty %}
                    <div class="h2h-empty">Игр в таком статусе не найдено</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="no-results">
            <i class="fa-solid fa-futbol no-results-icon"></i>
            <p class="no-results-text">Введите данные матча для начала анализа</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}